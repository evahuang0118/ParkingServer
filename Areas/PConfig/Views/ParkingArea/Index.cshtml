@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>區域列表</title>
    <link href="~/Content/layui/css/layui.css" rel="stylesheet" />
    <link href="~/Content/framework/css/console.css" rel="stylesheet" />
    <link href="~/Content/framework/css/animate.css" rel="stylesheet" />
    <link href="~/Content/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <script src="~/Content/jquery/jquery.min.js"></script>
    <script src="~/Content/layui/layui.js"></script>
    <script src="~/Content/framework/js/global.js"></script>
</head>
<body>
    <div class="panel animated fadeIn">
        <div class="panel-body">
            <fieldset class="layui-elem-field layuimini-search">
                <legend>搜索信息</legend>
                <div style="margin: 5px 5px 5px 5px">
                    <div class="layui-form layui-form-pane">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">區域名稱</label>
                                <div class="layui-input-inline">
                                    <input type="text" id="keyWord" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <button id="btnSearch" class="toolbar-search-button layui-btn layui-btn-normal layui-btn-small">
                                    <i class="layui-icon">&#xe615;</i>搜 索
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>

            <div id="toolbar" class="elight-table-toolbar">
                <div class="layui-btn-group"></div>
            </div>

            <table id="gridList" class="layui-form layui-table table-hover elight-table" lay-skin="row" lay-even="">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" lay-skin="primary">
                        </th>
                        <th>區域名稱</th>
                        <th>設定臨停車位數</th>
                        <th>設定月租車位數</th>
                        <th>剩餘臨停車位數</th>
                        <th>剩餘月租車位數</th>

                    </tr>
                </thead>
                <!--内容容器-->
                <tbody id="content"></tbody>
            </table>
            <div id="paged"></div>
        </div>
    </div>
</body>
</html>

<!--内容模板-->
<script id="contentTpl" type="text/html">
  {{#  layui.each(d.list, function(index, item){ }}
  <tr>
    <td>
      <input type="checkbox" lay-skin="primary" value="{{item.Id}}">
    </td>
    <td>{{item.AreaName}}</td>
    <td>{{item.TemporaryNum}}</td>
    <td>{{item.FixedNum}}</td>
    <td id = "{{item.Id}}-TRemainingNum">{{item.TRemainingNum}}</td>
    <td id = "{{item.Id}}-FRemainingNum">{{item.FRemainingNum}}</td>
  </tr>
  {{#  }); }}
  {{# if(d.list.length<=0) { }}
  <tr style="color: red">
    <td colspan="6">查無數據。</td>
  </tr>
  {{# } }}
</script>

<script type="text/javascript">

  var paging;
  layui.config({
    base: parent._baseUrl
  }).use(['paging', 'form', 'layer'], function () {
    var layer = parent.layer || layui.layer;
    var form = layui.form;
    paging = layui.paging();
    initGrid();
    $("#toolbar").authorizeButton();
    $('#btnSearch').click(initGrid);
    $('#keyWord').bindEnterEvent(initGrid);
  });

  function initGrid() {
    paging.init({
      url: '/PConfig/ParkingArea/Index',
      elem: '#content',
      tempElem: '#contentTpl',
      params: {
        keyWord: $("#keyWord").val()
      },
      pageConfig: {
        elem: 'paged',
        pageSize: 15,
      },
      success: function () {

      }
    });
  }

  function btn_add() {
    $.layerOpen({
      id: "add",
      title: "新增區域",
      width: "670px",
      height: "450px",
      content: "/PConfig/ParkingArea/Form",
      yes: function (iBody) {
          iBody.find('#btnSubmit').click();
          initGrid();
      }
    });
  }

  function btn_edit() {
    var ids = $("#gridList").gridSelectedRowValue();
    if (ids.length != 1) {
        $.layerMsg("請勾選單條記錄修改。", "warning");
        return;
    }
    $.layerOpen({
      id: "edit",
      title: "修改區域",
      width: "670px",
      height: "450px",
      content: "/PConfig/ParkingArea/Form?primaryKey=" + ids[0],
      yes: function (iBody) {
          iBody.find('#btnSubmit').click();
          initGrid();
      }
    });
  }

    function btn_delete() {
      var ids = $("#gridList").gridSelectedRowValue();
      if (ids.length < 1) {
          $.layerMsg("請勾選需要删除的選項。", "warning");
          return;
      }
      $.layerConfirm({
          content: "您已選中" + ids.length + "條數據, 確定删除嗎？",
          callback: function () {
              $.formSubmit({
                  url: '/PConfig/ParkingArea/Delete',
                  data: { primaryKey: ids[0] },
                  success: function () {
                      initGrid();
                  }
              });
          }
      });
  }


  // getParkingArea // add by steven 2023-09-18

  async function getParkingArea () {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/PConfig/ParkingArea/GetParkingArea", true);
    xhr.setRequestHeader("Content-Type", "application/json");
    // Define a callback function when the request completes
    xhr.onload = function () {
      if (xhr.status >= 200 && xhr.status < 300) {
        // Request was successful
        try {
          var jsonResponse = JSON.parse(xhr.responseText)
          var parkingAreaDataList = jsonResponse.data;
          for (var i = 0; i < parkingAreaDataList.length; ++i) {
            var parkingAreaData = parkingAreaDataList[i];
            document.getElementById(`${parkingAreaData.Id}-TRemainingNum`).innerHTML = parkingAreaData.TRemainingNum
            document.getElementById(`${parkingAreaData.Id}-FRemainingNum`).innerHTML = parkingAreaData.FRemainingNum
          }
          @* console.log('ParkingArea => ', ) *@
        }
        catch (e) {
          console.log(`Error : ${e}`)
        }
      } 
      else {
        console.log("response ", xhr.status)
        // Request failed
        // responseDiv.textContent = "Request failed with status: " + xhr.status;
      }
    };
    // Prepare and send the data
    var data = JSON.stringify({ key: "value" });
    xhr.send(data); 

  }
  
  console.log("getParkingAreaService -> ")

  var getParkingAreaService = window.setInterval(getParkingArea, 1000);

</script>
