@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>服务台共享车位确认(试用于酒店业务操作)</title>
    <link href="~/Content/layui/css/layui.css" rel="stylesheet" />
    <link href="~/Content/framework/css/console.css" rel="stylesheet" />
    <link href="~/Content/framework/css/animate.css" rel="stylesheet" />
    <link href="~/Content/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <script src="~/Content/jquery/jquery.min.js"></script>
    <script src="~/Content/layui/layui.js"></script>
    <script src="~/Content/framework/js/global.js"></script>
    <script src="~/Content/framework/js/com.js"></script>
</head>

<body>
    <div class="panel animated fadeIn">
        <div class="panel-body">
            <fieldset class="layui-elem-field layuimini-search">
                <legend>搜索信息</legend>
                <div style="margin: 5px 5px 5px 5px">
                    <div class="layui-form layui-form-pane">
                        <div class="layui-form-item">


                            <div class="layui-inline">
                                <label class="layui-form-label">車牌號碼</label>
                                <div class="layui-input-inline">
                                    <input type="text" id="PlateNo" autocomplete="off" class="layui-input"  />
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">入場時間</label>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="Intime" lay-verify="required"  name="Intime" placeholder="" autocomplete="off" />

                                </div>
                            </div>

                            <div class="layui-inline">
                                <button id="btnSearch" class="toolbar-search-button layui-btn layui-btn-normal layui-btn-small">
                                    <i class="layui-icon">&#xe615;</i>搜 索
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
            </fieldset>
            <div class="layui-row layui-col-space15">

                <div class="layui-col-md6">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top:2px;">
                        <legend><span style="font-size:14px;color:blue">在場車輛信息</span></legend>
                    </fieldset>

                    <table class="layui-form layui-table table-hover elight-table" lay-skin="row" lay-even="" style="margin-top:-13px;">
              
                        <tr>
                            <td>進出場次數</td>
                            <td>
                                <div class="layui-input-inline">
                                    <select name="InoutRules" id="InoutRules" lay-verify="required" style="width:120px;">
                                        <option value="1">單次</option>
                                        <option value="2">多次</option>
                                    </select>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>出入截止時段</td>
                            <td><input class="layui-input" id="Endtime" lay-verify="required" name="Endtime" placeholder="" autocomplete="off" style="width:190px;" /></td>
                        </tr>
                    </table>
                    <br />

                    <table class="layui-table" id="gridList" lay-filter="gridList" style="margin-top:-25px;"></table>

                </div>


                <script id="barDemo" type="text/html">
                    <a class="layui-btn layui-btn-xs" lay-event="detail">確 認</a>
                </script>
                <div class="layui-col-md6">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top:2px;">
                        <legend><span style="font-size:14px;color:crimson">車位佔用信息</span></legend>
                    </fieldset>
                    <table class="layui-table" id="gridLists" lay-filter="gridLists" style="margin-top:-25px;"></table>

                    <script type="text/html" id="State">
                        {{#  if(d.State=='1'){ }}
                        未离场
                        {{# }if(d.State=='2') { }}
                        已离场
                        {{#  }else{ }}
                        已回收
                        {{# } }}
                    </script>
                    <script type="text/html" id="IsCharge">
                        {{#  if(d.IsCharge=='1'){ }}
                        收 費
                        {{# }if(d.IsCharge=='0') { }}
                        不收費
                        {{#  }else{ }}

                        {{# } }}
                    </script>
                </div>
            </div>

            <blockquote class="layui-elem-quote">1 試用於需要共享車位的車輛，而系統無法提前預知車輛車牌信息 2 需要在停車場規定時間內,確認車輛為共享車,否則車輛出場時系統按臨停車計算收費</blockquote>
        </div>
    </div>
    <script src="~/Content/layui/layui.js" charset="utf-8"></script>
    <script src="~/Content/layui/layui.all.js"></script>
</body>

</html>
<script type="text/javascript">
    layui.config({
        base: parent._baseUrl
    }).use(['jquery', 'form', 'layer', 'laydate'], function () {
        var layer = layui.layer;
        var form = layui.form;
        var laydate = layui.laydate;
        laydate.render({
            elem: "#Intime"
            , type: 'datetime'
        });

        laydate.render({
            elem: "#Endtime"
            , type: 'datetime'
        });
    });

     layui.use(['form', 'table'], function () {
        var form = layui.form,
            table = layui.table;

        function initGrid() {
            table.render({
                elem: '#gridList',
                url: '/Report/InRecord/GIndex',
                method: 'post',
                cellMinWidth: 80,
                height: 'full-200',
                where: {
                    InTime: $("#Intime").val(),
                    PlateNo: $("#PlateNo").val(),
                    NoPlate: "0",
                    Etime: "",
                },
                cols: [[
                    { fixed: '',align: 'center', toolbar: '#barDemo',width:50 },
                    { field: 'Id', title: 'ID', hide: true },
                    { field: 'InPlate', title: '入場車牌', style: 'color:blue' ,width:100 },
                    { field: 'InTime', title: '入場時間', sort: true},
                ]],
                limits: [50, 80, 100, 150, 200],
                limit: 50,
                page: true,
                done: function (res, curr, count) {
                    if (res.data == null || res.data.length == 0) {
                        $('.layui-table-total').css({ display: "none" })

                    }
                }
            });
         }

         function initGrids() {
             table.render({
                 elem: '#gridLists',
                 url: '/Report/SharedOrg/GetParkingRecord',
                 method: 'post',
                 cellMinWidth: 80,
                 height: 'full-200',
                 cols: [[
                     { field: 'InPlate', width: 100, title: '車牌號碼', style: 'color:blue', fixed: 'left' },
                     { field: 'InTime', width: 170, title: '入場時間' },
                     { field: 'OutTime', width: 170, title: '出場時間' },
                     { field: 'State', width: 90, title: '狀 態', templet: '#State', style: 'color:blue' },
                     { field: 'IsCharge', width: 90, title: '收費', templet: '#IsCharge', style: 'color:red' },
                     { field: 'ORemark', width: 320, title: '備 註' },
                 ]],
                 done: function (res) {
                     if (res.data == null || res.data.length == 0) {
                         $('.layui-table-total').css({ display: "none" })
                     }
                 }
             });
         }

         initGrids();

         $('#btnSearch').on("click", function () {
              if ($("#Intime").val() != "" || $("#PlateNo").val() != "")
            initGrid();
        });

         table.on('tool(gridList)', function (obj) {
             var data = obj.data;
             if ($("#InoutRules").val() == "2" && $("#Endtime").val() == "") {
                 layer.msg("請設定出入截止時段!");
                 return;
             }
             if ($("#InoutRules").val() == "2" && (new Date(data.InTime) > new Date($("#Endtime").val()))) {
                 layer.msg("出入截止時段不能小於車輛的入場時段！");
                 return;
             }

             $.layerConfirm({
                 content: "您已選中記錄：" + data.InPlate + ",確定此車為共享車嗎？此操作不可恢復！",
                 callback: function () {
                     $.formSubmit({
                         url: '/Report/SharedOrg/SharedCalculate',
                         data: { recordId: data.Id, InoutRules: $("#InoutRules").val(),EndTime:$("#Endtime").val() },
                         success: function (data) {
                             if (data == "2") {
                                 initGrids();
                                 $("#Endtime").val("");
                             }
                             else if (data == "3") {
                                 layer.msg('確認失敗,在規定時間確認或記錄不能重復確認', {
                                     btn: ['确 定'],
                                 });
                                 $("#Endtime").val("");
                             }
                             else
                                 layer.msg('確認操作失敗！', {
                                       btn: ['确 定']
                                 });
                         }
                     });
                 }
             });
         });
     });

</script>

