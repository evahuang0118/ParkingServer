@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>相机识别记录报表</title>
    <link href="~/Content/layui/css/layui.css" rel="stylesheet" />
    <link href="~/Content/framework/css/console.css" rel="stylesheet" />
    <link href="~/Content/framework/css/animate.css" rel="stylesheet" />
    <link href="~/Content/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <script src="~/Content/jquery/jquery.min.js"></script>
    <script src="~/Content/layui/layui.js"></script>
    <script src="~/Content/framework/js/global.js"></script>
    <script src="~/Content/framework/js/com.js"></script>
</head>
<body>
    <div class="panel animated fadeIn">
        <div class="panel-body">
            <fieldset class="layui-elem-field layuimini-search">
                <legend>搜索信息</legend>
                <div style="margin: 5px 5px 5px 5px">
                    <div class="layui-form layui-form-pane">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">車牌號碼</label>
                                <div class="layui-input-inline">
                                    <input type="text" id="PlateNo" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">時段範圍</label>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="Btime" name="Btime" placeholder="" autocomplete="off" />
                                </div>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="Etime" name="Etime" placeholder="" autocomplete="off" />
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">出入車道</label>
                                <div class="layui-input-inline">
                                    <select lay-ignore class="layui-input" name="Channel" lay-verify="required" id="Channel" style="width: 190px;"></select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">出入類型</label>
                                <div class="layui-input-inline">
                                    <select name="ChannelType" id="ChannelType" lay-verify="required" style="width:190px;">
                                        <option value="0">=請選擇=</option>
                                        <option value="1">全部入口</option>
                                        <option value="2">全部出口</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label" >可信度</label>
                                <div class="layui-input-inline">
                                    <select name="Credibility" id="Credibility" lay-verify="required" style="width:190px;">
                                        <option value="0">請選擇</option>
                                        <option value="1">100</option>
                                        <option value="2">100-90</option>
                                        <option value="3">80-89</option>
                                        <option value="4">70-79</option>
                                        <option value="5">低於70</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <button id="btnSearch" class="toolbar-search-button layui-btn layui-btn-normal layui-btn-small">
                                    <i class="layui-icon">&#xe615;</i>搜 索
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>

            <table id="gridList" class="layui-form layui-table table-hover elight-table" lay-skin="row" lay-even="">
                <thead>
                    <tr>

                        <th>車牌號碼</th>
                        <th>辨識時間</th>
                        <th>出入車道</th>
                        <th>車牌圖片</th>
                        <th>出入類型</th>
                        <th>可信度</th>
                        <th>識別方式</th>
                    </tr>
                </thead>
                <!--内容容器-->
                <tbody id="content"></tbody>
            </table>
            <div id="paged"></div>

            <div class="layui-row layui-col-space15">
                <div class="layui-col-md5">
                    <div class="layui-tab-content">
                        <div class="layui-tab-item layui-show">
                            <div class="layui-colla-item">
                                <fieldset class="layui-elem-field layui-field-title" style="margin-top:2px;">
                                    <legend><span style="font-size:14px;color:blue">匯總統計</span></legend>
                                </fieldset>
                                <table class="layui-hide" id="grid_List" lay-filter="grid_Lists"></table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-col-md7">
                    <div class="layui-tab-content">
                        <div class="layui-tab-item layui-show">
                            <div class="layui-colla-item">
                                <fieldset class="layui-elem-field layui-field-title" style="margin-top:2px;">
                                    <legend><span style="font-size:14px;color:blue">報表說明</span></legend>
                                </fieldset>

                                <p style="color:currentColor" id="showContent">
                                    1.  此報表展示的是各個出入口相機的識別記錄
                                    <br>
                                    2.  報表默認不會顯示任何記錄,需要根據條件查詢刷選
                                    <br />
                                    3.  匯總統計是按照日期,通道號進行分類匯總
                                    <br />
                                    4.  點擊圖片可以查看出入大圖
                                </p>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="~/Content/layui/layui.js" charset="utf-8"></script>
    <script src="~/Content/layui/layui.all.js"></script>
    <script src="~/Content/layui_exts/excel.js"></script>
</body>
</html>

<!--内容模板-->
<script id="contentTpl" type="text/html">
    {{#  layui.each(d.list, function(index, item){ }}
    <tr>
        <td style="color:Highlight;width:120px">
            {{item.PlateNo}}
        </td>
        <td>
            {{item.RecognizeTime}}
        </td>
        <td>
            {{item.ChannelName}}
        </td>
        <td>
            <a onclick="ImgSearcher('{{item.CarImg}}')" href="javascript:void(0)"> <img style="height:70px;max-width:280px" alt="車牌圖片" src="{{item.PlateImg}}" /></a>
        </td>
        <td style="color:forestgreen">
            {{# if(item.InOutType==1){ }} 入 場
            {{# }else if(item.InOutType==2){ }} 出 場
            {{# }else if(item.InOutType==3){ }} 場 内
            {{# } }}
        </td>
        <td>
            {{item.Credibility}}
        </td>
        <td>
            {{# if(item.RecognizeType==2){ }} IO觸發
            {{# }else if(item.RecognizeType==4){ }} 車牌觸發
            {{# }else if(item.RecognizeType==8){ }} 虛擬觸發
            {{# } }}
        </td>
    </tr>
    {{#  }); }}
    {{# if(d.list.length<=0) { }}
    <tr style="color: red">
        <td colspan="6">查無數據。</td>
    </tr>
    {{# } }}
</script>

<script type="text/javascript">
    var paging;
    layui.config({
        base: parent._baseUrl
    }).use(['jquery', 'paging', 'form', 'layer', 'laydate'], function () {
        var layer = layui.layer;
        var form = layui.form;
        paging = layui.paging();
        var laydate = layui.laydate;

        laydate.render({
            elem: "#Etime"
            , type: 'datetime'

        });

        laydate.render({
            elem: "#Btime"
            , type: 'datetime'

        });

        initGrid();

        $('#btnSearch').click(initGrid);

        $("#Channel").bindSelect({
            url: "/PConfig/Channel/GetListTree"
        });

    });

    layui.use(['form', 'table'], function () {
        var form = layui.form,
            table = layui.table;

        function init_Grids() {
            table.render({
                elem: '#grid_List',
                url: '/Report/Licencerecogine/DaySummary',
                where: {
                    PlateNo: $("#PlateNo").val(),
                    Btime: $("#Btime").val(),
                    Etime: $("#Etime").val(),
                    Channels: $("#Channel").val(),
                    ChannelType: $("#ChannelType").val(),
                    Credibility: $("#Credibility").val()
                },
                method: 'post',
                cellMinWidth: 80,
                cols: [[
                    { field: 'date', title: '時  間' },
                    { field: 'channelName', title: '車 道' },
                    { field: 'Num', title: '識別數量' },
                ]],
                page: false,
                done: function (res) {
                    layuiRowspan("date", 1);
                    if (res.data == null || res.data.length == 0) {
                        $('.layui-table-total').css({ display: "none" })
                    }
                }
            });
        }

        init_Grids();

        $('#btnSearch').on("click", function () {
            init_Grids();
        });
    });

    var layuiRowspan = function (fieldNameTmp, index, flag) {
        let fieldName = [];
        if (typeof fieldNameTmp == "string") {
            fieldName.push(fieldNameTmp);
        } else {
            fieldName = fieldName.concat(fieldNameTmp);
        }
        for (let i = 0; i < fieldName.length; i++) {
            execRowspan(fieldName[i], index, flag);
        }
    }

    var execRowspan = function (fieldName, index, flag) {
        // 1为不冻结的情况，左侧列为冻结的情况
        let fixedNode = index == "1" ? $(".layui-table-body")[index - 1] : (index == "3" ? $(".layui-table-fixed-r") : $(".layui-table-fixed-l"));
        // 左侧导航栏不冻结的情况
        let child = $(fixedNode).find("td");
        let childFilterArr = [];
        // 获取data-field属性为fieldName的td
        for (let i = 0; i < child.length; i++) {
            if (child[i].getAttribute("data-field") == fieldName) {
                childFilterArr.push(child[i]);
            }
        }
        // 获取td的个数和种类
        let childFilterTextObj = {};
        for (let i = 0; i < childFilterArr.length; i++) {
            let childText = flag ? childFilterArr[i].innerHTML : childFilterArr[i].textContent;
            if (childFilterTextObj[childText] == undefined) {
                childFilterTextObj[childText] = 1;
            } else {
                let num = childFilterTextObj[childText];
                childFilterTextObj[childText] = num * 1 + 1;
            }
        }
        let canRowspan = true;
        let maxNum;//以前列单元格为基础获取的最大合并数
        let finalNextIndex;//获取其下第一个不合并单元格的index
        let finalNextKey;//获取其下第一个不合并单元格的值
        for (let i = 0; i < childFilterArr.length; i++) {
            (maxNum > 9000 || !maxNum) && (maxNum = $(childFilterArr[i]).prev().attr("rowspan") && fieldName != "8" ? $(childFilterArr[i]).prev().attr("rowspan") : 9999);
            let key = flag ? childFilterArr[i].innerHTML : childFilterArr[i].textContent;//获取下一个单元格的值
            let nextIndex = i + 1;
            let tdNum = childFilterTextObj[key];
            let curNum = maxNum < tdNum ? maxNum : tdNum;
            if (canRowspan) {
                for (let j = 1; j <= curNum && (i + j < childFilterArr.length);) {//循环获取最终合并数及finalNext的index和key
                    finalNextKey = flag ? childFilterArr[i + j].innerHTML : childFilterArr[i + j].textContent;
                    finalNextIndex = i + j;
                    if ((key != finalNextKey && curNum > 1) || maxNum == j) {
                        canRowspan = true;
                        curNum = j;
                        break;
                    }
                    j++;
                    if ((i + j) == childFilterArr.length) {
                        finalNextKey = undefined;
                        finalNextIndex = i + j;
                        break;
                    }
                }
                childFilterArr[i].setAttribute("rowspan", curNum);
                if ($(childFilterArr[i]).find("div.rowspan").length > 0) {//设置td内的div.rowspan高度适应合并后的高度
                    $(childFilterArr[i]).find("div.rowspan").parent("div.layui-table-cell").addClass("rowspanParent");
                    $(childFilterArr[i]).find("div.layui-table-cell")[0].style.height = curNum * 38 - 10 + "px";
                }
                canRowspan = false;
            } else {
                childFilterArr[i].style.display = "none";
            }
            if (--childFilterTextObj[key] == 0 | --maxNum == 0 | --curNum == 0 | (finalNextKey != undefined && nextIndex == finalNextIndex)) {//||(finalNextKey!=undefined&&key!=finalNextKey)
                canRowspan = true;
            }
        }
    }

    function initGrid() {
        paging.init({
            url: '/Report/Licencerecogine/Index',
            elem: '#content',
            tempElem: '#contentTpl',
            singleSelected: false,
            openWait: true,
            params: {
                PlateNo: $("#PlateNo").val(),
                Btime: $("#Btime").val(),
                Etime: $("#Etime").val(),
                Channel: $("#Channel").val(),
                ChannelType: $("#ChannelType").val(),
                Credibility: $("#Credibility").val()
            },
            pageConfig: {
                elem: 'paged',
                pageSize: 30,
            },
            success: function () {

            }
        });
    }

    function ImgSearcher(img) {
        $.layerOpen({
            title: "圖片放到",
            width: "550px",
            height: "450px",
            content: "/Report/Licencerecogine/FImg?primaryKey=" + img,
            btn: null
        });
    }

    function btn_Excel() {
        layui.use(['layer'], function () {
            var $ = layui.jquery
            var layer = layui.layer
            var excel = layui.excel

            $.ajax({
                url: '/Report/InRecord/Export?PlateNo=' + $("#PlateNo").val() + '&InTime=' + $("#Intime").val()
                , dataType: 'json'
                , success: function (res) {
                    var data = res.data
                    data = excel.filterExportData(data, {
                        InPlate: 'InPlate'
                        , InTime: 'InTime'
                        , InChannelName: 'InChannelName'
                        , OutPlate: 'OutPlate'
                        , OutTime: 'OutTime'
                        , BusinessName: 'BusinessName'
                        , Actual: 'Actual'
                    })
                    data.unshift({ InPlate: "入場車牌", InTime: "入場時間", InChannelName: '入口車道', OutPlate: "出場車牌", OutTime: "出場時間", BusinessName: '類型', Actual: "已付費" });
                    top.LAY_EXCEL.exportExcel({
                        sheet1: data
                    }, '未出場車輛記錄_' + getDateTime() + '.xlsx', 'xlsx')
                }
                , error: function () {
                    layer.alert('獲取數據失败!!!')
                }
            })
        })
    }
</script>