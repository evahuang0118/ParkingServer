@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>出入車流量匯總</title>

    <link href="~/Content/layui/css/layui.css" rel="stylesheet" />
    <link href="~/Content/framework/css/console.css" rel="stylesheet" />
    <link href="~/Content/framework/css/animate.css" rel="stylesheet" />
    <link href="~/Content/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <script src="~/Content/jquery/jquery.min.js"></script>
    <script src="~/Content/layui/layui.js"></script>
    <script src="~/Content/framework/js/global.js"></script>
    <script src="~/Content/framework/js/com.js"></script>
    <script src="~/Content/echarts/echarts.min.js"></script>
    <script src="~/Content/Print/jQuery.print.js"></script>
</head>
<body>
    <div class="panel animated fadeIn">
        <div class="panel-body">
            <fieldset class="layui-elem-field layuimini-search" id="search">
                <legend>搜索信息</legend>
                <div style="margin: 5px 5px 5px 5px">
                    <div class="layui-form layui-form-pane">
                        <div class="layui-form-item">

                            <div class="layui-inline">
                                <label class="layui-form-label">類  型</label>
                                <div class="layui-input-inline">
                                    <select lay-ignore class="layui-input" lay-verify="required" name="SearcherType" id="SearcherType" style="width: 190px;"></select>
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">日 期</label>

                                <div class="layui-input-inline" id="BdateTime" style="display:none">
                                    <input class="layui-input" id="Btime" name="Btime" placeholder="" autocomplete="off" />
                                </div>

                                <div class="layui-input-inline" id="EdateTime" style="display:none">
                                    <input class="layui-input" id="Etime" name="Etime" placeholder="" autocomplete="off" />
                                </div>

                                <div class="layui-input-inline" id="dateMonth" style="display:none">
                                    <input class="layui-input" id="Bmonth" name="Bmonth" placeholder="" autocomplete="off" />
                                </div>

                                <div class="layui-input-inline" id="dateYear" style="display:none">
                                    <input class="layui-input" id="Byear" name="Byear" placeholder="" autocomplete="off" />
                                </div>

                            </div>

                            <div class="layui-inline">
                                <button id="btnSearch" class="toolbar-search-button layui-btn layui-btn-normal layui-btn-small">
                                    <i class="layui-icon">&#xe615;</i>搜 索
                                </button>
                                <button class="layui-btn layui-btn-normal" type="button" id="btnExcel">導出Excel</button>
                                <button class="layui-btn layui-btn-normal" type="button" id="btnPrint">列  印</button>
                            </div>

                        </div>
                    </div>
                </div>
            </fieldset>
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md6">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top:2px;">
                        <legend><span style="font-size:14px;color:blue">分類統計</span></legend>
                    </fieldset>

                    <blockquote class="layui-elem-quote layui-text" style="display:none;text-align:center" id="toolbarInfo">
                        <span id="toolbar"></span>
                    </blockquote>

                    <table class="layui-hide" id="gridList" lay-filter="gridList" style="margin-top:-25px; border:2px" lay-skin="row" lay-even=""></table>

                    <p style="color:currentColor;" id="showContent">
                        1. 日報和周報,月報以及自定義是按日期,類型分組顯示相關數據
                        <br>
                        2. 年報按月,類型分組顯示相關數據
                        <br />
                        3. 匯總報表信息可以列印，導出Excel
                        <br />
                        4.分類匯總根據查詢條件對出入流量進行匯總統計
                    </p>

                </div>

                <div class="layui-col-md6">

                    <fieldset class="layui-elem-field layui-field-title" style="margin-top:2px;">
                        <legend><span style="font-size:14px;color:crimson">分類匯總</span></legend>
                    </fieldset>

                    <table class="layui-hide" id="gridLists" lay-filter="gridLists" style="margin-top:-25px; border:2px" lay-skin="row" lay-even=""></table>

                    <div id="columnarMap" class="layui-inline" style="width:550px;height:500px"></div>

                </div>
            </div>
        </div>
    </div>
    <script src="~/Content/layui/layui.js" charset="utf-8"></script>
    <script src="~/Content/layui/layui.all.js"></script>
    <script src="~/Content/layui_exts/excel.js"></script>
</body>
</html>
<script type="text/javascript">

    layui.config({
        base: parent._baseUrl
    }).use(['jquery', 'form', 'layer', 'laydate'], function () {
        var layer = layui.layer;
        var form = layui.form;
        var laydate = layui.laydate;

        $("#SearcherType").bindSelect({
            url: "/Report/SummaryRecord/GetSummaryType"
        });

        laydate.render({
            elem: "#Btime"
            , type: 'date'
        });

        laydate.render({
            elem: "#Etime"
            , type: 'date'
        });

        laydate.render({
            elem: "#Bmonth"
            , type: 'month'
        });

        laydate.render({
            elem: "#Byear"
            , type: 'year'
        });

        $("#SearcherType").change(function () {
            var vl = $('#SearcherType').val();
            $("#Btime").val("");
            $("#Etime").val("");
            $("#Bmonth").val("");
            $("#Byear").val("");

            if (vl == "1") {
                $("#BdateTime").show();
                $("#EdateTime").hide();
                $("#dateMonth").hide();
                $("#dateYear").hide();
            }
            else if (vl == "2") {
                $("#BdateTime").show();
                $("#EdateTime").hide();
                $("#dateMonth").hide();
                $("#dateYear").hide();
            }
            else if (vl == "3") {
                $("#BdateTime").hide();
                $("#EdateTime").hide();
                $("#dateMonth").show();
                $("#dateYear").hide();
            }
            else if (vl == "5") {
                $("#BdateTime").hide();
                $("#EdateTime").hide();
                $("#dateMonth").hide();
                $("#dateYear").show();
            }
            else if (vl == "6") {
                $("#BdateTime").show();
                $("#EdateTime").show();
                $("#dateMonth").hide();
                $("#dateYear").hide();
            }
        });
    });

    layui.use(['form', 'table'], function () {
        var form = layui.form,
            table = layui.table;

        function initGrid(Btime, Etime, payType) {
            table.render({
                elem: '#gridList',
                url: '/Report/SummaryRecord/TrafficSummary',
                where: {
                    Btime: Btime,
                    Etime: Etime,
                    SearchType: payType
                },
                method: 'post',
                cellMinWidth: 80,
                height: 'full-150',
                cols: [[
                    { field: 'Date', title: '日    期' },
                    { field: 'DataTypeName', title: '分   類' },
                    { field: 'Amount', width: 100, title: '合計數' },
                    { field: 'Count', width: 110, title: '臨停數量' },
                    { field: 'Num', width: 100, title: '月租數量' },
                ]],
                done: function (res) {
                    layuiRowspan("Date", 1);
                    if (res.data == null || res.data.length == 0) {
                        $('.layui-table-total').css({ display: "none" })
                    }
                    initGrids();
                }
            });
        }

        function initGrids() {
            table.render({
                elem: '#gridLists',
                url: '/Report/SummaryRecord/SummaryTraffic',
                method: 'post',
                cellMinWidth: 80,
                totalRow: true,
                cols: [[
                    { field: 'DataTypeName', title: '分   類', totalRowText: '合計' },
                    { field: 'Amount', width: 100, title: '合計數', totalRow: true },
                    { field: 'Count', width: 100, title: '臨停數量', totalRow: true },
                    { field: 'Num', width: 100, title: '月租數量', totalRow: true },

                ]],
                done: function (res) {
                    this.elem.next().find('.layui-table-total td[data-field="DataTypeName"]').parent().attr('style', "background:gainsboro;color:blue");

                    var myChart = echarts.init(document.getElementById('columnarMap'));
                    myChart.clear();

                    if (res.data == null || res.data.length == 0) {
                        $('.layui-table-total').css({ display: "none" })
                    }
                    else {
                        var xcoordinates = new Array();                    //x坐标内容
                        var ycoordinates = new Array();                   //y坐标内容
                        var bcoordinates = new Array();
                        var gcoordinates = new Array();

                        var data = res.data;
                        for (i = 0; i < data.length; i++) {
                            var str = "";
                            xcoordinates[i] = data[i].DataTypeName;
                            bcoordinates[i] = data[i].Amount;
                            ycoordinates[i] = data[i].Count;
                            gcoordinates[i] = data[i].Num;
                        }

                        // 交易笔数柱状图
                        var option = {
                            title: {
                                text: '車流量分析'
                            },
                            tooltip: {
                                trigger: 'axis',
                                axisPointer: {
                                    type: 'cross',
                                    crossStyle: {
                                        color: '#999'
                                    }
                                }
                            },
                            toolbox: {
                                feature: {
                                    dataView: { show: true, readOnly: false },
                                    magicType: { show: true, type: ['line', 'bar'] },
                                    restore: { show: true },
                                    saveAsImage: { show: true }
                                }
                            },
                            legend: {
                                data: ['總流量', '臨停', '月租']
                            },
                            xAxis: {
                                data: xcoordinates
                            },
                            yAxis: [
                                {
                                    type: 'value',
                                    name: '數量',
                                    min: 0,
                                    axisLabel: {
                                        formatter: '{value}'
                                    }
                                },
                            ],
                            series: [{
                                name: '總流量',
                                type: 'bar',
                                data: bcoordinates
                            },
                            {
                                name: '臨停',
                                type: 'bar',
                                data: ycoordinates
                            },
                            {
                                name: '月租',
                                type: 'bar',
                                data: gcoordinates
                            }
                            ]
                        };
                        myChart.setOption(option);
                    }
                }
            });
        }

        $('#btnSearch').on("click", function () {

            var val = $("#SearcherType").val();
            if (val == "0")
                return false;
            if ((val == "1" || val == "2") && $("#Btime").val() != "") {
                initGrid($("#Btime").val(), "", val);
            }
            else if (val == "3" && $("#Bmonth").val() != "") {
                initGrid($("#Bmonth").val(), "", val);
            }
            else if (val == "5" && $("#Byear").val() != "") {
                initGrid($("#Byear").val(), "", val);
            }
            else if (val == "6" && $("#Btime").val() != "" && $("#Etime").val() != "") {
                var btime = $("#Btime").val();
                var etime = $("#Etime").val();
                var sdate = new Date(btime);
                var now = new Date(etime);
                var days = now.getTime() - sdate.getTime();
                var day = parseInt(days / (1000 * 60 * 60 * 24));
                if (day > 31) {
                    alert("查詢時段範圍不能超過一個月！！！");
                    return false;
                }
                initGrid($("#Btime").val(), $("#Etime").val(), val);
            }
        });

        $('#btnExcel').on("click", function () {
            btn_Excel();
        });

        $('#Excel').on("click", function () {
            btnExcel();
        });

        $('#btnPrint').on("click", function () {
            btnPrint();
        });

    });

    var layuiRowspan = function (fieldNameTmp, index, flag) {
        let fieldName = [];
        if (typeof fieldNameTmp == "string") {
            fieldName.push(fieldNameTmp);
        } else {
            fieldName = fieldName.concat(fieldNameTmp);
        }
        for (let i = 0; i < fieldName.length; i++) {
            execRowspan(fieldName[i], index, flag);
        }
    }

    var execRowspan = function (fieldName, index, flag) {
        // 1为不冻结的情况，左侧列为冻结的情况
        let fixedNode = index == "1" ? $(".layui-table-body")[index - 1] : (index == "3" ? $(".layui-table-fixed-r") : $(".layui-table-fixed-l"));
        // 左侧导航栏不冻结的情况
        let child = $(fixedNode).find("td");
        let childFilterArr = [];
        // 获取data-field属性为fieldName的td
        for (let i = 0; i < child.length; i++) {
            if (child[i].getAttribute("data-field") == fieldName) {
                childFilterArr.push(child[i]);
            }
        }
        // 获取td的个数和种类
        let childFilterTextObj = {};
        for (let i = 0; i < childFilterArr.length; i++) {
            let childText = flag ? childFilterArr[i].innerHTML : childFilterArr[i].textContent;
            if (childFilterTextObj[childText] == undefined) {
                childFilterTextObj[childText] = 1;
            } else {
                let num = childFilterTextObj[childText];
                childFilterTextObj[childText] = num * 1 + 1;
            }
        }
        let canRowspan = true;
        let maxNum;//以前列单元格为基础获取的最大合并数
        let finalNextIndex;//获取其下第一个不合并单元格的index
        let finalNextKey;//获取其下第一个不合并单元格的值
        for (let i = 0; i < childFilterArr.length; i++) {
            (maxNum > 9000 || !maxNum) && (maxNum = $(childFilterArr[i]).prev().attr("rowspan") && fieldName != "8" ? $(childFilterArr[i]).prev().attr("rowspan") : 9999);
            let key = flag ? childFilterArr[i].innerHTML : childFilterArr[i].textContent;//获取下一个单元格的值
            let nextIndex = i + 1;
            let tdNum = childFilterTextObj[key];
            let curNum = maxNum < tdNum ? maxNum : tdNum;
            if (canRowspan) {
                for (let j = 1; j <= curNum && (i + j < childFilterArr.length);) {//循环获取最终合并数及finalNext的index和key
                    finalNextKey = flag ? childFilterArr[i + j].innerHTML : childFilterArr[i + j].textContent;
                    finalNextIndex = i + j;
                    if ((key != finalNextKey && curNum > 1) || maxNum == j) {
                        canRowspan = true;
                        curNum = j;
                        break;
                    }
                    j++;
                    if ((i + j) == childFilterArr.length) {
                        finalNextKey = undefined;
                        finalNextIndex = i + j;
                        break;
                    }
                }
                childFilterArr[i].setAttribute("rowspan", curNum);
                if ($(childFilterArr[i]).find("div.rowspan").length > 0) {//设置td内的div.rowspan高度适应合并后的高度
                    $(childFilterArr[i]).find("div.rowspan").parent("div.layui-table-cell").addClass("rowspanParent");
                    $(childFilterArr[i]).find("div.layui-table-cell")[0].style.height = curNum * 38 - 10 + "px";
                }
                canRowspan = false;
            } else {
                childFilterArr[i].style.display = "none";
            }
            if (--childFilterTextObj[key] == 0 | --maxNum == 0 | --curNum == 0 | (finalNextKey != undefined && nextIndex == finalNextIndex)) {//||(finalNextKey!=undefined&&key!=finalNextKey)
                canRowspan = true;
            }
        }
    }

    function btn_Excel() {
        var val = $("#SearcherType").val();
        if (val == "0")
            return false;
        var str = "";
        if ((val == "1" || val == "2") && $("#Btime").val() != "") {
            str = $("#Btime").val();
        }
        else if (val == "3" && $("#Bmonth").val() != "") {
            str = $("#Bmonth").val();
        }
        else if (val == "5" && $("#Byear").val() != "") {
            str = $("#Byear").val();
        }
        else if (val == "6" && $("#Btime").val() != "" && $("#Etime").val() != "") {
            str = $("#Btime").val() + "至" + $("#Etime").val();
        }
        window.location.href = "/Report/SummaryRecord/TrafficExportFile?str=" + str;
    }

    function btnExcel() {
              layui.use(['layer'], function () {
            var $ = layui.jquery
            var layer = layui.layer
            var excel = layui.excel

            $.ajax({
                url: '/Report/SummaryRecord/TrafficExport'
                , dataType: 'json'
                , success: function (res) {
                    var data = res.data
                    data = excel.filterExportData(data, {
                          DataTypeName: 'DataTypeName'
                        , Amount: 'Amount'
                        , Count: 'Count'
                        , Num:'Num'
                    })
                    data.unshift({
                        DataTypeName: "分  類",
                        Amount: '合計數',
                        Count: "臨停數量",
                        Num:"月租數量",
                    });
                    top.LAY_EXCEL.exportExcel({
                        sheet1: data
                    }, '車流量匯總報表.xlsx', 'xlsx')
                }
                , error: function () {
                    layer.alert('獲取數據失败!!!')
                }
            })
        })
    }

    function btnPrint() {
        $("#search").hide();
        $("#showContent").hide();
        var vl = $('#SearcherType').val();
        var info = "";
        if (vl == "1") {

            info = "日 報:" + $("#Btime").val();
        }
        else if (vl == "2") {
            info = "周 報:" + $("#Btime").val();
        }
        else if (vl == "3") {
            info = "月 報:" + $("#Bmonth").val();
        }
        else if (vl == "5") {
            info = "年 報:" + $("#Byear").val();
        }
        else if (vl == "6") {
            info = "統計範圍:" + $("#Btime").val() + " 至 " + $("#Etime").val();
        }

        $("#toolbar").html(info);
        $("#toolbarInfo").show();
        $(".layui-row layui-col-space15").print({
            globalStyles: true,             //是否包含父文档的样式，默认为true
            mediaPrint: false,             //是否包含media='print'的链接标签。会被globalStyles选项覆盖，默认为false
            stylesheet: null,             //外部样式表的URL地址，默认为null
            noPrintSelector: ".no-print",//不想列印的元素的jQuery选择器，默认为".no-print"
            iframe: true,               //是否使用一个iframe来替代列印表单的弹出窗口，true为在本頁面进行列印，false就是说新开一个頁面列印，默认为true
            append: null,              //将内容添加到列印内容的后面
            prepend: null,            //将内容添加到列印内容的前面，可以用来作为要列印内容
            deferred: $.Deferred().done(function () {
                $("#search").show();
                $("#showContent").show();
                $("#toolbarInfo").hide();
            })
        });
    }

</script>