@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>车流量</title>
    <link href="~/Content/layui/css/layui.css" rel="stylesheet" />
    <link href="~/Content/framework/css/console.css" rel="stylesheet" />
    <link href="~/Content/framework/css/animate.css" rel="stylesheet" />
    <link href="~/Content/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <script src="~/Content/jquery/jquery.min.js"></script>
    <script src="~/Content/layui/layui.js"></script>
    <script src="~/Content/framework/js/global.js"></script>
    <script src="~/Content/framework/js/com.js"></script>
</head>

<body>
    <div class="panel animated fadeIn">
        <div class="panel-body">
            <fieldset class="layui-elem-field layuimini-search">
                <legend>搜索信息</legend>
                <div style="margin: 5px 5px 5px 5px">
                    <div class="layui-form layui-form-pane">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">時段範圍</label>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="Btime" name="Btime" placeholder="" autocomplete="off" />
                                </div>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="Etime" name="Etime" placeholder="" autocomplete="off" />
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:120px">出入車道</label>
                                <div class="layui-input-inline">
                                    <select lay-ignore class="layui-input" name="Channel" lay-verify="required" id="Channel" style="width: 190px;"></select>
                                </div>
                            </div>

                            <div class="layui-inline">
                                <button id="btnSearch" class="toolbar-search-button layui-btn layui-btn-normal layui-btn-small">
                                    <i class="layui-icon">&#xe615;</i>搜 索
                                </button>
                                <button class="layui-btn layui-btn-normal" type="button" id="btnExcel">導出Excel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>

            <div class="layui-tab layui-tab-brief" lay-filter="chargePlan">
                <ul class="layui-tab-title">
                    <li class="layui-this" id="1">入場流量</li>
                    <li id="2">出場流量</li>
                </ul>

                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md6">

                        <div class="layui-tab-content">
                            <div class="layui-tab-item layui-show">
                                <fieldset class="layui-elem-field layui-field-title" style="margin-top:2px;">
                                    <legend><span style="font-size:14px;color:blue">日統計</span></legend>
                                </fieldset>
                                <table id="gridList" class="layui-form layui-table table-hover elight-table" lay-skin="" lay-even="">
                                    <thead>
                                        <tr>

                                            <th>時 間</th>
                                            <th>總車次</th>
                                            <th>臨 停</th>
                                            <th>月 租</th>
                                            <th>  </th>
                                        </tr>
                                    </thead>
                                    <!--内容容器-->
                                    <tbody id="content"></tbody>
              
                                </table>
                            </div>
                            <div id="paged"></div>
                        </div>
                    </div>
                    <div class="layui-col-md6">
                        <div class="layui-tab-content">
                            <div class="layui-tab-item layui-show">
                                <fieldset class="layui-elem-field layui-field-title" style="margin-top:2px;">
                                    <legend><span style="font-size:14px;color:blue">日分時段統計</span></legend>
                                </fieldset>
                                <table id="gridLists" class="layui-form layui-table table-hover elight-table" lay-skin="row" lay-even="">
                                    <thead>
                                        <tr>
                                            <th>時  段</th>
                                            <th>總車次</th>
                                            <th>臨  停</th>
                                            <th>月  租</th>

                                        </tr>
                                    </thead>
                                    <tbody id="contents"></tbody>
                                </table>
                            </div>
                            <div id="pageds"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <script src="~/Content/layui/layui.js" charset="utf-8"></script>
    <script src="~/Content/layui/layui.all.js"></script>
    <script src="~/Content/layui_exts/excel.js"></script>
</body>
</html>

<!--内容模板-->
<script id="contentTpl" type="text/html">
    {{#  layui.each(d.list, function(index, item){ }}
    <tr>
        <td style="width:150px">
            {{item.Date}}日
        </td>
        <td>
            {{item.Num}}
        </td>
        <td>
            {{#  if(item.CNum!=null){ }} {{item.CNum}}
            {{# }else{ }} 0
            {{# } }} {{ }}
        </td>
        <td>
        </td>
        <td>
            <a onclick="btn_Detail('{{item.Date}}')" href="javascript:void(0)" style="color:blue">分時段統計</a>
        </td>
    </tr>

    {{#  }); }}
    {{# if(d.list.length<=0) { }}
    <tr style="color: red">
        <td colspan="5">查無數據。</td>
    </tr>
    {{# } }}

    <tr style="color:blue">
        <td>合  計</td>
        <td id="tm"></td>
        <td id="lm"></td>
        <td id="gm"></td>
        <td></td>
    </tr>
</script>

<script id="contentTpls" type="text/html">
    {{#  layui.each(d.list, function(index, item){ }}
    <tr>
        <td style="width:150px">
            {{item.Date}}時
        </td>
        <td>
            {{item.Num}}
        </td>
        <td>
            {{#  if(item.CNum!=null){ }} {{item.CNum}}
            {{# }else{ }} 0
            {{# } }} {{ }}
        </td>
        <td>
        </td>
    </tr>
    {{#  }); }}
    {{# if(d.list.length<=0) { }}
    <tr style="color: red">
        <td colspan="4">查無數據。</td>
    </tr>
    {{# } }}

    <tr style="color:blue">
        <td>合  計</td>
        <td id="ftm"></td>
        <td id="flm"></td>
        <td id="fgm"></td>
    </tr>
</script>

<script type="text/javascript">
    var paging;
    var current_id = 1;

    layui.config({
        base: parent._baseUrl
    }).use(['paging', 'form', 'layer', 'element', 'laydate'], function () {
        var layer = parent.layer || layui.layer;
        var form = layui.form;
        var element = layui.element;
        var laydate = layui.laydate;
        paging = layui.paging();

        laydate.render({
            elem: "#Etime"
            , type: 'datetime'
            , value: getendDateTime()

        });

        laydate.render({
            elem: "#Btime"
            , type: 'datetime'
            , value: getbeginDateTime()

        });

        $("#Channel").bindSelect({
            url: "/PConfig/Channel/GetListTree"
        });

        initGrid(current_id);

        element.on('tab(chargePlan)', function (data) {
            current_id = $(this).attr("id");
            initGrid(current_id);
        });
    });

    $('#btnSearch').on('click', function () {
        if ($("#Btime").val() == "" && $("#Etime").val() == "") {
            alert("查詢時間不能為空,請輸入查詢時間條件!");
            return false;
        }
        var btime = $("#Btime").val();
        var etime = $("#Etime").val();
        var sdate = new Date(btime);
        var now = new Date(etime);
        var days = now.getTime() - sdate.getTime();
        var day = parseInt(days / (1000 * 60 * 60 * 24));
        if (day > 31) {
            alert("查詢時間段範圍不能超過一個月！！！");
            return false;
        }
        initGrid(current_id);
    });

    $('#btnExcel').on("click", function () {
        btn_Excel();
    });

    function initGrid(curr) {
        paging.init({
            url: '/Report/OutRecord/Traffic',
            elem: '#content',
            tempElem: '#contentTpl',
            paged: false,
            params: {
                type: curr,
                beginTime: ($("#Btime").val() == "" ? getbeginDateTime() : $("#Btime").val()),
                endTime: ($("#Etime").val() == "" ? getendDateTime() : $("#Etime").val()),
                Channel: $("#Channel").val()
            },
            pageConfig: {
                elem: 'paged',
                pageSize: 50,
            },
            success: function () {
                var tm = 0;
                var lm = 0;
                var gm = 0;
                $('#content tr').each(function () {
                    var num = Number($(this).find("td:nth-child(2)").html()) - Number($(this).find("td:nth-child(3)").html());
                    $(this).find("td:nth-child(4)").html(num);

                    tm += Number($(this).find("td:nth-child(2)").html());
                    lm += Number($(this).find("td:nth-child(3)").html());
                    gm += num;
                });
                $("#tm").html(tm.toString());
                $("#lm").html(lm.toString());
                $("#gm").html(gm.toString());
            }
        });
    }

    function btn_Detail(btime) {
        paging.init({
            url: '/Report/OutRecord/HourTraffic',
            elem: '#contents',
            tempElem: '#contentTpls',
            paged: false,
            params: {
                type: current_id,
                btime: btime,
                Channel: $("#Channel").val()
            },
            pageConfig: {
                elem: 'pageds',
                pageSize: 50,
            },
            success: function () {
                var tm = 0;
                var lm = 0;
                var gm = 0;

                $('#contents tr').each(function () {
                    var num = Number($(this).find("td:nth-child(2)").html()) - Number($(this).find("td:nth-child(3)").html()=="" ? "0":$(this).find("td:nth-child(3)").html());
                    $(this).find("td:nth-child(4)").html(num);

                    tm += Number($(this).find("td:nth-child(2)").html());
                    lm += Number($(this).find("td:nth-child(3)").html());
                    gm += num;
                })

                $("#ftm").html(tm.toString());
                $("#flm").html(lm.toString());
                $("#fgm").html(gm.toString());
            }
        });
        }

    function btn_Excel() {
        layui.use(['layer'], function () {
            var $ = layui.jquery
            var layer = layui.layer
            var excel = layui.excel
            var stInfo = "入場";
            if (current_id==2)
                 stInfo= "出場";

            $.ajax({
                url: '/Report/OutRecord/TrafficExport'
                , dataType: 'json'
                , success: function (res) {
                    var data = res.data
                    data = excel.filterExportData(data, {
                          Date: 'Date'
                        , Num: 'Num'
                        , CNum: 'CNum'
                        , GNum: 'GNum'
                    })
                    data.unshift({
                       Date: "日  期",
                        Num: "總車次",
                        CNum:'臨  停',
                        GNum: "月 租",
                    });
                    top.LAY_EXCEL.exportExcel({
                        sheet1: data
                    }, stInfo +'車次統計報表_' + $("#Btime").val() + "至" + $("#Etime").val() + '.xlsx', 'xlsx')
                }
                , error: function () {
                    layer.alert('獲取數據失敗!!!')
                }
            })
        })
    }

</script>
