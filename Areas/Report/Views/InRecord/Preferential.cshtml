@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>本地服務台折扣操作</title>
    <link href="~/Content/layui/css/layui.css" rel="stylesheet" />
    <link href="~/Content/framework/css/console.css" rel="stylesheet" />
    <link href="~/Content/framework/css/animate.css" rel="stylesheet" />
    <link href="~/Content/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <script src="~/Content/jquery/jquery.min.js"></script>
    <script src="~/Content/layui/layui.js"></script>
    <script src="~/Content/framework/js/global.js"></script>
    <script src="~/Content/framework/js/com.js"></script>
</head>
<body>
    <div class="panel animated fadeIn">
        <div class="panel-body">
            <fieldset class="layui-elem-field layuimini-search">
                <legend>搜索訊息</legend>
                <div style="margin: 5px 5px 5px 5px">
                    <div class="layui-form layui-form-pane">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <div class="layui-input-inline">
                                    <select name="selectNoPlate" class="layui-input" id="selectNoPlate" lay-verify="required">
                                        <option value="0">所有車</option>
                                        <option value="1">無牌車</option>
                                    </select>
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">車牌號碼</label>
                                <div class="layui-input-inline">
                                    <input type="text" id="PlateNo" autocomplete="off" class="layui-input" />
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">入場時間</label>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="Intime" lay-verify="required" name="Intime" placeholder="" autocomplete="off" />

                                </div>
                            </div>

                            <div class="layui-inline">
                                <button id="btnSearch" class="toolbar-search-button layui-btn layui-btn-normal layui-btn-small">
                                    <i class="layui-icon">&#xe615;</i>搜 尋
                                </button>
                            </div>
                            <div class="layui-inline">
                                <div id = "currentDiscountPointsForm" class="layui-form-item">
                                    <div class="layui-inline">
                                        點數 : <input readonly class="layui-input" style = "width : 75px" id="CurrentDiscountPoints" lay-verify="required" name="CurrentDiscountPoints" placeholder="" autocomplete="off" /></div>
                                    <div class="layui-inline">
                                        時數 : <input readonly class="layui-input" style = "width : 75px" id="CurrentDiscountDurations" lay-verify="required" name="CurrentDiscountDurations" placeholder="" autocomplete="off" /></div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </fieldset>

            <div class="layui-row layui-col-space5">
                <div class="layui-col-md4">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top:2px;">
                        <legend><span style="font-size:14px;color:green">選擇車輛 《步驟一》</span></legend>
                    </fieldset>
                    <table class="layui-table" id="gridList" lay-filter="gridList" style="margin-top:-25px;"></table>
                </div>

                <script id="barDemo" type="text/html">
                    <a class="layui-btn layui-btn-xs" lay-event="detail">選擇</a>
                </script>

                <div class="layui-col-md4">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top:2px;">
                        <legend><span style="font-size:14px;color:blue">選擇類型 《步驟二》</span></legend>
                    </fieldset>
                    <table class="layui-table" id="gridLists" lay-filter="gridLists" style="margin-top:-25px;"></table>
                </div>

                <script id="barsDemo" type="text/html">
                    <a class="layui-btn layui-btn-xs" lay-event="detail">選擇</a>
                </script>

                <div class="layui-col-md4">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top:2px;">
                        <legend><span style="font-size:14px;color:crimson">折扣操作 《步驟三》</span></legend>
                    </fieldset>

                    <form id="form" class="layui-form" style="margin-top: 30px;">
                        @Html.AntiForgeryToken()
                        <div class="layui-form-item">

                            <div class="layui-inline">
                                <label class="layui-form-label">車牌號碼</label>
                                <div class="layui-input-inline">
                                    <input type="hidden" name="recordId" id="recordId" />
                                    <input type="text" id="plate" autocomplete="off" class="layui-input" />
                                </div>
                            </div>

                        </div>

                        <div class="layui-form-item">

                            <div class="layui-inline">
                                <label class="layui-form-label">折扣類型</label>
                                <div class="layui-input-inline">
                                    <input type="hidden" name="VouchersId" id="VouchersId" />
                                    <input type="hidden" name="VouchersType" id="VouchersType" />
                                    <input type="hidden" name="VouchersAmountTime" id="VouchersAmountTime" />
                                    <input type="hidden" name="DiscountLimitType" id="DiscountLimitType" />
                                    <input type="hidden" name="DiscountMaxValue" id="DiscountMaxValue" />
                                    <input type="text" id="Vouchers" autocomplete="off" class="layui-input" />
                                </div>
                            </div>
                        </div>

                        <div class="layui-form-item">

                            <div class="layui-inline">
                                <label class="layui-form-label">折扣張數</label>
                                <div class="layui-input-inline">
                                    <input type="text" id="VouchersNum" autocomplete="off" class="layui-input" />
                                </div>
                            </div>

                        </div>

                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <button id="btnSubmit" class="layui-btn layui-btn-radius" lay-submit lay-filter="saveBasicInfo">提交保存</button>

                                <button id="btnClean" type="button" class="layui-btn layui-btn-warm layui-btn-radius">清   除</button>
                            </div>
                        </div>
                    </form>

                </div>
            </div>
            <blockquote class="layui-elem-quote">操作步驟： 輸入查詢條件搜索記錄 =》 選擇相應車牌記錄 =》 選擇折扣類型 =》核對訊息 =》 提交保存 </blockquote>
        </div>
    </div>
    <script src="~/Content/layui/layui.js" charset="utf-8"></script>
    <script src="~/Content/layui/layui.all.js"></script>
</body>
</html>
<script type="text/javascript">


  layui.config({
        base: parent._baseUrl
    }).use(['jquery', 'form', 'layer', 'laydate'], function () {
        var layer = layui.layer;
        var form = layui.form;
        var laydate = layui.laydate;
        laydate.render({
            elem: "#Intime"
            , type: 'datetime'
        });
    });

     layui.use(['form', 'table'], function () {
        var form = layui.form,
            table = layui.table;

        function initGrid() {
            table.render({
                elem: '#gridList',
                url: '/Report/InRecord/GIndex',
                method: 'post',
                cellMinWidth: 80,
                height: 'full-200',
                where: {
                    InTime: $("#Intime").val(),
                    PlateNo: $("#PlateNo").val(),
                    NoPlate: $("#selectNoPlate").val(),
                    Etime:"",
                },
                cols: [[
                    { fixed: '',align: 'center', toolbar: '#barDemo',width:60 },
                    { field: 'Id', title: 'ID', hide: true },
                    { field: 'InPlate', title: '入場車牌', style: 'color:blue' ,width: 100 },
                    { field: 'InTime', title: '入場時間', sort: true ,width: 180 },
                    { field: 'InPlateImg', width: 170,title: '車牌圖片', templet: '<div><img style="width:160px;max-height:55px;max-width:160px" src="{{d.InPlateImg}}"></div>' },
                ]],
                limits: [50, 80, 100, 150, 200],
                limit: 50,
                page: true,
                done: function (res, curr, count) {
                    if (res.data == null || res.data.length == 0) {
                        $('.layui-table-total').css({ display: "none" })
                    }
                }
            });
         }

         function initGrids() {
             table.render({
                 elem: '#gridLists',
                 url: '/PBusiness/OptimalFree/GetOptimalFree',
                 method: 'post',
                 cellMinWidth: 80,
                 height: 'full-200',
                 where: {
                     Type:"2",
                 },
                 cols: [[
                     { fixed: '', align: 'center', toolbar: '#barsDemo', width: 60 },
                     { field: 'Fid', title: 'Fid', hide: true },
                     { field: 'Type', title: 'Type', hide: true },
                     { field: 'AmountTime', title: 'AmountTime', hide: true },
                     { field: 'DiscountLimitType', title: 'DiscountLimitType', hide: true }, // add by steven 2023-10-07 // 上限種類 
                     { field: 'DiscountMaxValue', title: 'DiscountMaxValue', hide: true }, //
                     { field: 'Name', title: '折扣類型', style: 'color:blue',},
                 ]],
                 limits: [50, 80, 100, 150, 200],
                 limit: 50,
                 page: true,
                 done: function (res, curr, count) {
                    console.log("initGrid Res => ", res)
                     if (res.data == null || res.data.length == 0) {
                         $('.layui-table-total').css({ display: "none" })
                     }
                 }
             });
         }
         
         
         function initCurrentPoints() {
            $.ajax({
                url: "/PBusiness/OptimalFree/GetCurrentDiscountPointsInfo",
                data: {  },
                type: "post",
                dataType: "json",
                async: false,
                success: function (data) {
                    console.log("get form data => ", data)
                    $("#currentDiscountPointsForm").formSerialize(data);
                }
            });
         }

         initGrids();
         try {
             initCurrentPoints();
         } catch (ex) {
             console.log("try init current pointes failed ", ex)
         }

         $('#btnSearch').on("click", function () {
             if ($("#Intime").val() != "" || $("#PlateNo").val() != "")
                 initGrid();
         });

         table.on('tool(gridList)', function (obj) {
             var data = obj.data;
             $("#plate").val(data.InPlate);
             $("#recordId").val(data.Id);
         });

         table.on('tool(gridLists)', function (obj) {
             var data = obj.data;
             $("#Vouchers").val(data.Name);
             $("#VouchersId").val(data.Fid);
             $("#VouchersType").val(data.Type);
             $("#VouchersAmountTime").val(data.AmountTime);
             $("#VouchersNum").val(1);
             $("#DiscountLimitType").val(data.DiscountLimitType);
             $("#DiscountMaxValue").val(data.DiscountMaxValue);
         });

         form.on('submit(saveBasicInfo)', function (data) {

             if ($("#plate").val() == "" || $("#Vouchers").val() == "") {
                 $.layerMsg("車牌號碼和折扣類型不能為空！", "warning");
                 return false;
             }
             data.field.plate = $("#plate").val();
             data.field.VouchersNum = $("#VouchersNum").val();
             data.field.DiscountLimitType = $("#DiscountLimitType").val();
             data.field.DiscountMaxValue = $("#DiscountMaxValue").val();
             data.field.Comment = "網頁折扣操作" // add by steven
             data.field.DiscountName = $("#Vouchers").val(); // add by steven
            console.log("submit => ", data.field)
             $.formSubmit({
                 url: "/Report/InRecord/PreferentialForm",
                 data: data.field,
                 success: function (layero, index) {
                    console.log("layero => ", layero)
                     $("#plate").val("");
                     $("#Vouchers").val("");
                     $("#VouchersNum").val("");
                     $("#recordId").val("");
                     $("#discountlimittype").val("");
                     $("#discountmaxvalue").val("");
                     
                     initCurrentPoints();
                 },

             })
             return false;
         });

         $('#btnClean').on("click", function () {
             $("#plate").val("");
             $("#Vouchers").val("");
             $("#VouchersNum").val("");
             $("#recordId").val("");
             $("#VouchersId").val("");
            $("#VouchersNum").val("");
            $("#recordId").val("");
         });
     });

</script>
